<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Meeting | Apresentação</title>
    <link rel="stylesheet" href="tela.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <div class="container-apresentacao">
        <!-- Área do Vídeo -->
        <div class="area-video">
            <!-- O vídeo será adicionado posteriormente pelo cliente -->
            <video id="video-apresentacao">
                <!-- Fonte do vídeo será adicionada pelo cliente -->
                <source src="/upload/sorteio-speed-coutdown.mp4" type="video/mp4">
                Seu navegador não suporta a tag de vídeo.
            </video>
            
            <!-- Botão de Sorteio -->
            <div id="botao-sorteio-container">
                <button id="botao-iniciar-sorteio" class="botao-sorteio">
                    <i class="fas fa-random"></i>
                    <span>Iniciar Sorteio</span>
                </button>
            </div>
        </div>
        
        <!-- Área do Sorteado -->
        <div class="area-sorteado" id="area-sorteado">
            <div class="cabecalho-sorteado">
                <div class="logo-sorteado">
                    <h2>Speed Meeting</h2>
                    <span>Rodada de Negócios</span>
                </div>
                <div class="titulo-sorteado">Sorteado</div>
            </div>
            <div class="conteudo-sorteado escondido" id="conteudo-sorteado">
                <div class="contador">Sorteado #<span id="numero-sorteio">1</span></div>
                <div class="nome-sorteado" id="nome-sorteado">Nome do Participante</div>
                <div class="empresa-sorteada" id="empresa-sorteada">Empresa do Participante</div>
            </div>
        </div>
    </div>
    
    <!-- Script -->
    <script>
        // Quando a página for carregada
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Tela de apresentação Speed Meeting - Inicializada com sucesso');
            
            // Captura referências dos elementos
            const video = document.getElementById('video-apresentacao');
            const conteudoSorteado = document.getElementById('conteudo-sorteado');
            const numeroSorteio = document.getElementById('numero-sorteio');
            const nomeSorteado = document.getElementById('nome-sorteado');
            const empresaSorteada = document.getElementById('empresa-sorteada');
            const botaoIniciarSorteio = document.getElementById('botao-iniciar-sorteio');
            const botaoSorteioContainer = document.getElementById('botao-sorteio-container');
            
            let participantesDisponiveis = [];
            let palestraId = null;
            let sorteioEmProgresso = false;
            
            // Função para receber mensagens do index.html (painel de controle)
            window.addEventListener('message', function(event) {
                // Verificar se a mensagem contém dados de inicialização
                if (event.data && event.data.tipo === 'inicializar') {
                    participantesDisponiveis = event.data.participantesDisponiveis;
                    palestraId = event.data.palestraId;
                    
                    // Mostrar o botão de sorteio
                    botaoSorteioContainer.classList.add('visivel');
                }
            });
            
            // Evento de clique no botão de sorteio
            botaoIniciarSorteio.addEventListener('click', function() {
                if (sorteioEmProgresso || participantesDisponiveis.length === 0) return;
                
                // Indicar que o sorteio está em andamento
                sorteioEmProgresso = true;
                
                // Desabilitar botão e mostrar carregando
                botaoIniciarSorteio.disabled = true;
                botaoIniciarSorteio.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Sorteando...</span>';
                
                // Iniciar o vídeo
                video.play();
                
                // Esconder botão durante a reprodução
                botaoSorteioContainer.classList.remove('visivel');
                
                // Após 5 segundos, realizar o sorteio
                setTimeout(function() {
                    realizarSorteio();
                }, 5000); // 5 segundos
            });
            
            // Função para realizar o sorteio
            function realizarSorteio() {
                // Sortear aleatoriamente
                const indiceAleatorio = Math.floor(Math.random() * participantesDisponiveis.length);
                const participanteSorteado = participantesDisponiveis[indiceAleatorio];
                
                // Remover o participante sorteado da lista disponível
                participantesDisponiveis.splice(indiceAleatorio, 1);
                
                // Criar registro de sorteio
                const horario = new Date().toLocaleTimeString();
                const ordem = document.querySelector('#numero-sorteio').textContent || 1;
                const novoSorteado = {
                    nome: participanteSorteado.nome,
                    empresa: participanteSorteado.empresa,
                    horario,
                    ordem: parseInt(ordem)
                };
                
                // Exibir os dados do sorteado
                numeroSorteio.textContent = novoSorteado.ordem;
                nomeSorteado.textContent = novoSorteado.nome;
                empresaSorteada.textContent = novoSorteado.empresa;
                conteudoSorteado.classList.remove('escondido');
                
                // Lançar confetes
                lancarConfetes();
                
                // Enviar mensagem de volta para a janela principal
                window.opener.postMessage({
                    tipo: 'sorteioRealizado',
                    sorteado: novoSorteado,
                    palestraId: palestraId
                }, '*');
                
                // Resetar estado do sorteio
                sorteioEmProgresso = false;
                
                // Se ainda há participantes disponíveis, mostrar o botão novamente após o vídeo
                if (participantesDisponiveis.length > 0) {
                    video.addEventListener('ended', function videoTerminou() {
                        // Resetar botão de sorteio
                        botaoIniciarSorteio.disabled = false;
                        botaoIniciarSorteio.innerHTML = '<i class="fas fa-random"></i><span>Iniciar Sorteio</span>';
                        botaoSorteioContainer.classList.add('visivel');
                        
                        // Remover este evento para não acumular
                        video.removeEventListener('ended', videoTerminou);
                    });
                }
            }
            
            // Função para lançar confetes 
            function lancarConfetes() {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#FFD400', '#7B1FA2', '#4CAF50', '#FF5252', '#2196F3']
                });
            }
        });
    </script>
</body>
</html>